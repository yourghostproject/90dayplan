# Create a production-ready single-file HTML app for a 90-day tracker (Oct–Dec 2025)
# Features:
# - Daily task tracker (Twine, Upwork, SoundBetter applications, TikTok daily, YouTube every 2 days)
# - One buffer day allowed per week (Mon–Sun)
# - Calendar view for Oct, Nov, Dec 2025 with progress indicators
# - Sales pipeline (add/edit/delete deals, status, amount, source, category, currency)
# - Monthly revenue summaries and charts (by month and by source)
# - Settings: start date (default today), export/import data (JSON), reset
# - All data saved to localStorage
# - Clean Tailwind UI, no build step; Chart.js via CDN
# - Works on GitHub Pages (pure client-side)

import os, textwrap, json, datetime as dt

html = r"""<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>YGP — 90-Day Music Hustle Tracker (Oct–Dec 2025)</title>
  <meta name="description" content="Track daily outreach and content, manage your sales pipeline, and hit your 90-day goals.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root { --accent: #7c3aed; }
    html, body { height: 100%; }
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'; }
    .badge { @apply inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-semibold; }
    .chip { @apply inline-flex items-center rounded-full px-2.5 py-1 text-xs font-medium; }
    .btn { @apply inline-flex items-center gap-2 rounded-xl px-4 py-2 font-semibold shadow-sm transition active:scale-[.98]; }
    .btn-primary { @apply bg-violet-600 text-white hover:bg-violet-700; }
    .btn-outline { @apply border border-slate-300 hover:bg-slate-50; }
    .card { @apply rounded-2xl border border-slate-200 bg-white shadow-sm; }
    .section { @apply max-w-7xl mx-auto px-4 sm:px-6 lg:px-8; }
    .tab-active { @apply text-violet-700 border-b-2 border-violet-700; }
    .kbd { @apply px-2 py-0.5 rounded border text-xs font-mono bg-slate-50; }
    .checkbox { width: 18px; height: 18px; }
    .pill { @apply px-2 py-0.5 rounded-full text-xs font-semibold; }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-100 text-slate-800">
  <header class="border-b bg-white/70 backdrop-blur sticky top-0 z-30">
    <div class="section py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-9 w-9 rounded-xl bg-violet-600 flex items-center justify-center text-white font-extrabold">Y</div>
        <div>
          <h1 class="text-lg sm:text-xl font-extrabold tracking-tight">YGP — 90-Day Music Hustle Tracker</h1>
          <p class="text-xs sm:text-sm text-slate-500">From <span id="range-start">Oct 1, 2025</span> to <span id="range-end">Dec 31, 2025</span> • Europe/London</p>
        </div>
      </div>
      <nav class="flex items-center gap-2">
        <button data-tab="tracker" class="tab-link px-3 py-2 text-sm font-semibold border-b-2 border-transparent hover:text-violet-700">Daily Tracker</button>
        <button data-tab="pipeline" class="tab-link px-3 py-2 text-sm font-semibold border-b-2 border-transparent hover:text-violet-700">Sales Pipeline</button>
        <button data-tab="settings" class="tab-link px-3 py-2 text-sm font-semibold border-b-2 border-transparent hover:text-violet-700">Settings</button>
      </nav>
    </div>
  </header>

  <main class="section py-6 space-y-6">
    <!-- KPI Row -->
    <section class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div class="card p-4">
        <p class="text-xs uppercase tracking-wide text-slate-500">This Week</p>
        <p class="mt-2 text-3xl font-extrabold"><span id="kpi-week-complete">0</span>%</p>
        <p class="text-xs text-slate-500 mt-1">Completion of required tasks (Mon–Sun)</p>
      </div>
      <div class="card p-4">
        <p class="text-xs uppercase tracking-wide text-slate-500">Streak</p>
        <p class="mt-2 text-3xl font-extrabold"><span id="kpi-streak">0</span> days</p>
        <p class="text-xs text-slate-500 mt-1">Consecutive days fully completed</p>
      </div>
      <div class="card p-4">
        <p class="text-xs uppercase tracking-wide text-slate-500">Revenue (this month)</p>
        <p class="mt-2 text-3xl font-extrabold">£<span id="kpi-revenue">0</span></p>
        <p class="text-xs text-slate-500 mt-1">Closed Won only</p>
      </div>
      <div class="card p-4">
        <p class="text-xs uppercase tracking-wide text-slate-500">Buffer Day</p>
        <p class="mt-2 text-3xl font-extrabold"><span id="kpi-buffer">Available</span></p>
        <p class="text-xs text-slate-500 mt-1">Max 1 per week (Mon–Sun)</p>
      </div>
    </section>

    <!-- Tabs -->
    <section id="tab-tracker" class="space-y-6">
      <div class="card p-4">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
          <div class="flex items-center gap-2 text-sm">
            <span class="chip bg-slate-100">Daily: Twine, Upwork, SoundBetter, TikTok</span>
            <span class="chip bg-slate-100">YouTube Remix: every 2 days</span>
            <span class="chip bg-slate-100">1 buffer day / week</span>
          </div>
          <div class="flex items-center gap-2">
            <button id="btn-today" class="btn btn-outline">Jump to Today</button>
            <button id="btn-expand" class="btn btn-outline">Expand All</button>
            <button id="btn-collapse" class="btn btn-outline">Collapse All</button>
          </div>
        </div>
      </div>

      <!-- Calendars -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="card p-4">
          <h3 class="font-bold text-slate-700">October 2025</h3>
          <div id="cal-oct" class="mt-3 grid grid-cols-7 gap-2 text-xs"></div>
        </div>
        <div class="card p-4">
          <h3 class="font-bold text-slate-700">November 2025</h3>
          <div id="cal-nov" class="mt-3 grid grid-cols-7 gap-2 text-xs"></div>
        </div>
        <div class="card p-4">
          <h3 class="font-bold text-slate-700">December 2025</h3>
          <div id="cal-dec" class="mt-3 grid grid-cols-7 gap-2 text-xs"></div>
        </div>
      </div>
    </section>

    <section id="tab-pipeline" class="hidden space-y-6">
      <div class="card p-4">
        <h3 class="font-bold text-slate-700 mb-3">Add Deal</h3>
        <form id="deal-form" class="grid grid-cols-1 md:grid-cols-6 gap-3">
          <div class="md:col-span-2">
            <label class="text-xs text-slate-500">Client / Project</label>
            <input required id="deal-client" class="w-full mt-1 rounded-xl border-slate-300 focus:ring-violet-600 focus:border-violet-600" placeholder="Artist / Brand / Project">
          </div>
          <div class="md:col-span-2">
            <label class="text-xs text-slate-500">Source</label>
            <select id="deal-source" class="w-full mt-1 rounded-xl border-slate-300 focus:ring-violet-600 focus:border-violet-600">
              <option>Twine</option>
              <option>Upwork</option>
              <option>SoundBetter</option>
              <option>YouTube/TikTok</option>
              <option>Direct/Email</option>
              <option>Referral</option>
              <option>Other</option>
            </select>
          </div>
          <div class="md:col-span-2">
            <label class="text-xs text-slate-500">Category</label>
            <select id="deal-category" class="w-full mt-1 rounded-xl border-slate-300 focus:ring-violet-600 focus:border-violet-600">
              <option>Production</option>
              <option>Mixing</option>
              <option>Mastering</option>
              <option>Mentorship</option>
              <option>Sync/Library</option>
              <option>Other</option>
            </select>
          </div>
          <div class="md:col-span-2">
            <label class="text-xs text-slate-500">Amount</label>
            <div class="flex gap-2 mt-1">
              <select id="deal-currency" class="rounded-xl border-slate-300 focus:ring-violet-600 focus:border-violet-600">
                <option value="GBP">£</option>
                <option value="USD">$</option>
                <option value="EUR">€</option>
              </select>
              <input id="deal-amount" type="number" step="0.01" class="w-full rounded-xl border-slate-300 focus:ring-violet-600 focus:border-violet-600" placeholder="e.g., 150.00">
            </div>
          </div>
          <div class="md:col-span-2">
            <label class="text-xs text-slate-500">Status</label>
            <select id="deal-status" class="w-full mt-1 rounded-xl border-slate-300 focus:ring-violet-600 focus:border-violet-600">
              <option>Lead</option>
              <option>In Discussion</option>
              <option>In Production</option>
              <option>Closed Won</option>
              <option>Closed Lost</option>
            </select>
          </div>
          <div class="md:col-span-2">
            <label class="text-xs text-slate-500">Close Date</label>
            <input id="deal-date" type="date" class="w-full mt-1 rounded-xl border-slate-300 focus:ring-violet-600 focus:border-violet-600">
          </div>
          <div class="md:col-span-6">
            <label class="text-xs text-slate-500">Notes</label>
            <input id="deal-notes" class="w-full mt-1 rounded-xl border-slate-300 focus:ring-violet-600 focus:border-violet-600" placeholder="Scope, deliverables, next steps...">
          </div>
          <div class="md:col-span-6 flex items-center gap-2 mt-2">
            <button class="btn btn-primary" type="submit">Add Deal</button>
            <button id="btn-export" class="btn btn-outline" type="button">Export JSON</button>
            <label for="import-file" class="btn btn-outline cursor-pointer">Import JSON</label>
            <input id="import-file" type="file" accept="application/json" class="hidden">
            <button id="btn-reset-pipeline" class="btn btn-outline" type="button">Reset Pipeline</button>
          </div>
        </form>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="card p-4 lg:col-span-2">
          <h3 class="font-bold text-slate-700 mb-3">Pipeline</h3>
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm" id="pipeline-table">
              <thead>
                <tr class="text-left text-slate-500">
                  <th class="py-2">Client</th>
                  <th>Source</th>
                  <th>Category</th>
                  <th>Amount</th>
                  <th>Status</th>
                  <th>Date</th>
                  <th>Notes</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="pipeline-body"></tbody>
            </table>
          </div>
        </div>
        <div class="space-y-6">
          <div class="card p-4">
            <h3 class="font-bold text-slate-700 mb-3">Revenue Summary (Closed Won)</h3>
            <div class="grid grid-cols-3 gap-2 text-sm">
              <div class="p-3 bg-slate-50 rounded-xl">
                <p class="text-xs text-slate-500">October</p>
                <p class="font-extrabold text-lg">£<span id="rev-oct">0</span></p>
              </div>
              <div class="p-3 bg-slate-50 rounded-xl">
                <p class="text-xs text-slate-500">November</p>
                <p class="font-extrabold text-lg">£<span id="rev-nov">0</span></p>
              </div>
              <div class="p-3 bg-slate-50 rounded-xl">
                <p class="text-xs text-slate-500">December</p>
                <p class="font-extrabold text-lg">£<span id="rev-dec">0</span></p>
              </div>
            </div>
          </div>
          <div class="card p-4">
            <h3 class="font-bold text-slate-700 mb-3">Charts</h3>
            <canvas id="chart-months" height="180"></canvas>
            <canvas id="chart-sources" height="180" class="mt-6"></canvas>
          </div>
        </div>
      </div>
    </section>

    <section id="tab-settings" class="hidden space-y-6">
      <div class="card p-4">
        <h3 class="font-bold text-slate-700 mb-3">Preferences</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="text-xs text-slate-500">Start Date (for streaks)</label>
            <input id="pref-start" type="date" class="w-full mt-1 rounded-xl border-slate-300 focus:ring-violet-600 focus:border-violet-600">
          </div>
          <div>
            <label class="text-xs text-slate-500">YouTube cadence</label>
            <select id="pref-yt-cadence" class="w-full mt-1 rounded-xl border-slate-300 focus:ring-violet-600 focus:border-violet-600">
              <option value="2">Every 2 days</option>
              <option value="3">Every 3 days</option>
              <option value="1">Daily</option>
            </select>
          </div>
        </div>
        <div class="mt-4 flex items-center gap-2">
          <button id="btn-save-prefs" class="btn btn-primary">Save Preferences</button>
          <button id="btn-reset-tracker" class="btn btn-outline">Reset Tracker</button>
        </div>
      </div>
      <div class="text-xs text-slate-500">
        <p>All data is stored locally in your browser (localStorage). Safe for GitHub Pages.</p>
      </div>
    </section>
  </main>

  <footer class="section py-8 text-center text-xs text-slate-500">
    Built for Gauthier • Your Ghost Project • <span class="font-semibold">Oct–Dec 2025</span>
  </footer>

<script>
// ------------------ Utilities ------------------
const LSK = {
  tracker: 'ygp90.tracker.v1',
  pipeline: 'ygp90.pipeline.v1',
  prefs: 'ygp90.prefs.v1'
};

const GBP = (n) => (n||0).toLocaleString('en-GB', {minimumFractionDigits:0});

function startOfWeek(d) {
  const date = new Date(d);
  const day = (date.getDay() + 6) % 7; // Monday=0
  date.setDate(date.getDate() - day);
  date.setHours(0,0,0,0);
  return date;
}
function endOfWeek(d) {
  const s = startOfWeek(d);
  const e = new Date(s);
  e.setDate(s.getDate() + 6);
  e.setHours(23,59,59,999);
  return e;
}

function fmtDateISO(d) {
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}
function fromISO(s) {
  const [y,m,d] = s.split('-').map(Number);
  return new Date(y, m-1, d);
}

// ------------------ Preferences ------------------
const defaultPrefs = {
  startDate: '2025-09-26', // today (Europe/London)
  ytCadence: 2
};

const prefs = JSON.parse(localStorage.getItem(LSK.prefs) || 'null') || defaultPrefs;
function savePrefs(){ localStorage.setItem(LSK.prefs, JSON.stringify(prefs)); }

// ------------------ Tracker Data ------------------
// For each date ISO: { tasks: {twine, upwork, soundbetter, tiktok, youtube}, buffer: bool }
const tracker = JSON.parse(localStorage.getItem(LSK.tracker) || '{}');
function saveTracker(){ localStorage.setItem(LSK.tracker, JSON.stringify(tracker)); }

// ------------------ Pipeline Data ------------------
let pipeline = JSON.parse(localStorage.getItem(LSK.pipeline) || '[]');
function savePipeline(){ localStorage.setItem(LSK.pipeline, JSON.stringify(pipeline)); }

// ------------------ Tabs ------------------
const tabs = document.querySelectorAll('.tab-link');
const tabPanels = {
  tracker: document.getElementById('tab-tracker'),
  pipeline: document.getElementById('tab-pipeline'),
  settings: document.getElementById('tab-settings')
};
function activateTab(name){
  tabs.forEach(btn => {
    if(btn.dataset.tab === name){ btn.classList.add('tab-active'); }
    else { btn.classList.remove('tab-active'); }
  });
  Object.entries(tabPanels).forEach(([k,el]) => {
    el.classList.toggle('hidden', k !== name);
  });
}
tabs.forEach(btn => btn.addEventListener('click', () => activateTab(btn.dataset.tab)));
activateTab('tracker');

// ------------------ Calendar Build ------------------
const rangeStart = new Date(2025, 9-1, 1); // Oct 1
const rangeEnd = new Date(2025, 12-1, 31); // Dec 31
document.getElementById('range-start').textContent = rangeStart.toLocaleDateString('en-GB', {month:'short', day:'numeric', year:'numeric'});
document.getElementById('range-end').textContent = rangeEnd.toLocaleDateString('en-GB', {month:'short', day:'numeric', year:'numeric'});

function monthGrid(year, monthIdx, mountId){
  const mount = document.getElementById(mountId);
  mount.innerHTML = '';
  // Weekday headers
  ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'].forEach(d => {
    const el = document.createElement('div');
    el.className = 'text-slate-400 font-semibold text-center';
    el.textContent = d;
    mount.appendChild(el);
  });
  const first = new Date(year, monthIdx, 1);
  const last = new Date(year, monthIdx+1, 0);
  const startPad = (first.getDay() + 6) % 7; // Monday index
  for(let i=0;i<startPad;i++){
    const pad = document.createElement('div');
    mount.appendChild(pad);
  }
  for(let d=1; d<=last.getDate(); d++){
    const date = new Date(year, monthIdx, d);
    mount.appendChild(dayCell(date));
  }
}

function isRequired(dateISO, task){
  // YouTube required every prefs.ytCadence days starting from prefs.startDate
  if(task !== 'youtube') return true;
  const start = fromISO(prefs.startDate);
  const d = fromISO(dateISO);
  const diff = Math.floor((d - start) / (1000*60*60*24));
  return (diff % prefs.ytCadence) === 0;
}

function bufferUsedThisWeek(date){
  const sw = startOfWeek(date);
  const ew = endOfWeek(date);
  for(const [iso, rec] of Object.entries(tracker)){
    const d = fromISO(iso);
    if(d >= sw && d <= ew && rec.buffer) return true;
  }
  return false;
}

function dayCell(date){
  const iso = fmtDateISO(date);
  if(!tracker[iso]) tracker[iso] = { tasks: {twine:false, upwork:false, soundbetter:false, tiktok:false, youtube:false}, buffer:false };
  const rec = tracker[iso];

  const todayISO = fmtDateISO(new Date());
  const isToday = iso === todayISO;
  const required = {
    twine: true, upwork: true, soundbetter: true, tiktok: true, youtube: isRequired(iso,'youtube')
  };

  const wrap = document.createElement('div');
  wrap.className = 'rounded-xl border p-2 hover:shadow-sm transition relative ' + (isToday ? 'border-violet-500 ring-1 ring-violet-200' : 'border-slate-200 bg-white');
  if(rec.buffer){
    wrap.classList.add('bg-amber-50','border-amber-300');
  }

  const head = document.createElement('div');
  head.className = 'flex items-center justify-between';
  head.innerHTML = `<div class="font-bold ${isToday ? 'text-violet-700' : ''}">${date.getDate()}</div>
    <div class="flex items-center gap-1">
      ${rec.buffer ? '<span class="pill bg-amber-200 text-amber-900">Buffer</span>' : ''}
      <span class="pill bg-slate-100 text-slate-600">${progressForDay(iso)}%</span>
    </div>`;
  wrap.appendChild(head);

  const list = document.createElement('div');
  list.className = 'mt-2 space-y-1';
  [['twine','Twine'],['upwork','Upwork'],['soundbetter','SoundBetter'],['tiktok','TikTok'],['youtube','YouTube']].forEach(([key,label]) => {
    const row = document.createElement('label');
    const requiredMark = required[key] ? '' : ' (optional today)';
    row.className = 'flex items-center justify-between gap-2 p-1 rounded hover:bg-slate-50';
    row.innerHTML = `<span class="text-xs">${label}${requiredMark ? '<span class="text-slate-400">'+requiredMark+'</span>':''}</span>`;
    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.className = 'checkbox';
    cb.checked = !!rec.tasks[key];
    cb.addEventListener('change', () => {
      rec.tasks[key] = cb.checked;
      saveTracker(); refreshKPIs();
      // update mini progress chip
      head.querySelector('.pill:last-child').textContent = progressForDay(iso)+'%';
    });
    row.appendChild(cb);
    list.appendChild(row);
  });
  wrap.appendChild(list);

  const actions = document.createElement('div');
  actions.className = 'mt-2 flex items-center justify-between';
  const bufBtn = document.createElement('button');
  bufBtn.className = 'text-xs underline text-amber-700';
  bufBtn.textContent = rec.buffer ? 'Remove buffer day' : 'Mark buffer day';
  bufBtn.addEventListener('click', () => {
    if(!rec.buffer){
      if(bufferUsedThisWeek(date)){
        alert('Buffer already used this week (Mon–Sun).');
        return;
      }
      rec.buffer = true;
      // When buffer, unrequire tasks (we keep existing ticks)
    } else {
      rec.buffer = false;
    }
    saveTracker(); rebuildCalendars(); refreshKPIs();
  });
  actions.appendChild(bufBtn);

  const clrBtn = document.createElement('button');
  clrBtn.className = 'text-xs text-slate-500 underline';
  clrBtn.textContent = 'Clear';
  clrBtn.addEventListener('click', () => {
    rec.tasks = {twine:false, upwork:false, soundbetter:false, tiktok:false, youtube:false};
    rec.buffer = false;
    saveTracker(); rebuildCalendars(); refreshKPIs();
  });
  actions.appendChild(clrBtn);
  wrap.appendChild(actions);

  return wrap;
}

function progressForDay(iso){
  const rec = tracker[iso];
  if(rec.buffer) return 100;
  const reqs = ['twine','upwork','soundbetter','tiktok','youtube'].filter(k => isRequired(iso,k));
  const done = reqs.filter(k => rec.tasks[k]).length;
  return Math.round((done / reqs.length) * 100);
}

function rebuildCalendars(){
  monthGrid(2025, 9, 'cal-oct');
  monthGrid(2025, 10, 'cal-nov');
  monthGrid(2025, 11, 'cal-dec');
}
rebuildCalendars();

// Jump to today: scroll to the containing month
document.getElementById('btn-today').addEventListener('click', () => {
  const today = new Date();
  const m = today.getMonth();
  const target = (m===9)?'cal-oct':(m===10)?'cal-nov':(m===11)?'cal-dec':null;
  if(target){
    document.getElementById(target).scrollIntoView({behavior:'smooth', block:'center'});
  }
});
document.getElementById('btn-expand').addEventListener('click', () => {
  document.querySelectorAll('#cal-oct > div, #cal-nov > div, #cal-dec > div').forEach(el => el.classList.remove('collapsed'));
});
document.getElementById('btn-collapse').addEventListener('click', () => {
  document.querySelectorAll('#cal-oct > div, #cal-nov > div, #cal-dec > div').forEach(el => el.classList.add('collapsed'));
});

// ------------------ KPIs ------------------
function refreshKPIs(){
  // Week completion: average of required-complete days (Mon-Sun) for current week
  const now = new Date();
  const sw = startOfWeek(now);
  let sum = 0, count = 0;
  for(let i=0;i<7;i++){
    const d = new Date(sw); d.setDate(sw.getDate()+i);
    const iso = fmtDateISO(d);
    if(d < rangeStart || d > rangeEnd) continue;
    sum += progressForDay(iso);
    count++;
  }
  const weekPct = count? Math.round(sum/count) : 0;
  document.getElementById('kpi-week-complete').textContent = weekPct;

  // Streak: consecutive fully-completed days (100%) since prefs.startDate
  let streak = 0;
  const start = fromISO(prefs.startDate);
  for(let d = new Date(); d >= start; d.setDate(d.getDate()-1)){
    const iso = fmtDateISO(d);
    if(!tracker[iso]) break;
    const pct = progressForDay(iso);
    if(pct === 100) streak++; else break;
  }
  document.getElementById('kpi-streak').textContent = streak;

  // Buffer availability
  const buf = bufferUsedThisWeek(new Date()) ? 'Used' : 'Available';
  document.getElementById('kpi-buffer').textContent = buf;

  // Revenue this month (GBP only for KPI)
  const nowM = new Date().getMonth();
  const monthStart = new Date(new Date().getFullYear(), nowM, 1);
  const monthEnd = new Date(new Date().getFullYear(), nowM+1, 0);
  let rev = 0;
  pipeline.forEach(p => {
    if(p.status === 'Closed Won' && p.currency === 'GBP' && p.date){
      const d = new Date(p.date);
      if(d >= monthStart && d <= monthEnd) rev += Number(p.amount||0);
    }
  });
  document.getElementById('kpi-revenue').textContent = GBP(rev);
}
refreshKPIs();

// ------------------ Settings ------------------
document.getElementById('pref-start').value = prefs.startDate;
document.getElementById('pref-yt-cadence').value = String(prefs.ytCadence);
document.getElementById('btn-save-prefs').addEventListener('click', () => {
  prefs.startDate = (document.getElementById('pref-start').value || prefs.startDate);
  prefs.ytCadence = Number(document.getElementById('pref-yt-cadence').value || 2);
  savePrefs(); rebuildCalendars(); refreshKPIs();
});
document.getElementById('btn-reset-tracker').addEventListener('click', () => {
  if(confirm('Reset all daily tracker data?')){
    localStorage.removeItem(LSK.tracker);
    location.reload();
  }
});

// ------------------ Pipeline Logic ------------------
const tbody = document.getElementById('pipeline-body');
function renderPipeline(){
  tbody.innerHTML = '';
  pipeline.forEach((p, idx) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="py-2">${p.client||''}</td>
      <td>${p.source||''}</td>
      <td>${p.category||''}</td>
      <td>${p.currency||'GBP'} ${Number(p.amount||0).toFixed(2)}</td>
      <td>
        <span class="chip ${p.status==='Closed Won'?'bg-green-100 text-green-800':
                            p.status==='Closed Lost'?'bg-rose-100 text-rose-800':
                            p.status==='In Production'?'bg-violet-100 text-violet-800':
                            'bg-slate-100 text-slate-700'}">${p.status||''}</span>
      </td>
      <td>${p.date||''}</td>
      <td class="max-w-[240px] truncate" title="${(p.notes||'').replace(/"/g,'&quot;')}">${p.notes||''}</td>
      <td class="text-right">
        <button data-edit="${idx}" class="text-xs underline text-slate-600 mr-2">Edit</button>
        <button data-del="${idx}" class="text-xs underline text-rose-600">Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
  attachRowHandlers();
  updateRevenueSummaries();
  drawCharts();
}
function attachRowHandlers(){
  tbody.querySelectorAll('[data-del]').forEach(btn => btn.addEventListener('click', () => {
    const i = Number(btn.dataset.del);
    if(confirm('Delete this deal?')){
      pipeline.splice(i,1); savePipeline(); renderPipeline(); refreshKPIs();
    }
  }));
  tbody.querySelectorAll('[data-edit]').forEach(btn => btn.addEventListener('click', () => {
    const i = Number(btn.dataset.edit);
    const p = pipeline[i];
    // Load into form for quick edit
    document.getElementById('deal-client').value = p.client||'';
    document.getElementById('deal-source').value = p.source||'Other';
    document.getElementById('deal-category').value = p.category||'Other';
    document.getElementById('deal-currency').value = p.currency||'GBP';
    document.getElementById('deal-amount').value = p.amount||'';
    document.getElementById('deal-status').value = p.status||'Lead';
    document.getElementById('deal-date').value = p.date||'';
    document.getElementById('deal-notes').value = p.notes||'';
    // When resubmitted, replace instead of push
    document.getElementById('deal-form').dataset.editing = String(i);
    document.getElementById('deal-form').scrollIntoView({behavior:'smooth', block:'center'});
  }));
}
document.getElementById('deal-form').addEventListener('submit', (e) => {
  e.preventDefault();
  const rec = {
    client: document.getElementById('deal-client').value.trim(),
    source: document.getElementById('deal-source').value,
    category: document.getElementById('deal-category').value,
    currency: document.getElementById('deal-currency').value,
    amount: parseFloat(document.getElementById('deal-amount').value||'0'),
    status: document.getElementById('deal-status').value,
    date: document.getElementById('deal-date').value,
    notes: document.getElementById('deal-notes').value.trim()
  };
  const editIdx = document.getElementById('deal-form').dataset.editing;
  if(editIdx !== undefined && editIdx !== ''){
    pipeline[Number(editIdx)] = rec;
    document.getElementById('deal-form').dataset.editing = '';
  } else {
    pipeline.push(rec);
  }
  savePipeline(); renderPipeline(); e.target.reset(); refreshKPIs();
});

// Export / Import / Reset
document.getElementById('btn-export').addEventListener('click', () => {
  const data = {
    prefs, tracker, pipeline
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'ygp-90day-tracker.json';
  a.click();
});
document.getElementById('import-file').addEventListener('change', (e) => {
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    try {
      const data = JSON.parse(reader.result);
      if(data.prefs) localStorage.setItem(LSK.prefs, JSON.stringify(data.prefs));
      if(data.tracker) localStorage.setItem(LSK.tracker, JSON.stringify(data.tracker));
      if(data.pipeline) localStorage.setItem(LSK.pipeline, JSON.stringify(data.pipeline));
      alert('Data imported.');
      location.reload();
    } catch(err){
      alert('Invalid JSON.');
    }
  };
  reader.readAsText(file);
});
document.getElementById('btn-reset-pipeline').addEventListener('click', () => {
  if(confirm('Reset entire pipeline?')){
    localStorage.removeItem(LSK.pipeline);
    pipeline = []; renderPipeline(); refreshKPIs();
  }
});

// Revenue summaries (GBP only for simplicity)
function updateRevenueSummaries(){
  const months = { '2025-10':0, '2025-11':0, '2025-12':0 };
  pipeline.forEach(p => {
    if(p.status !== 'Closed Won' || p.currency !== 'GBP' || !p.date) return;
    const ym = p.date.slice(0,7);
    if(months[ym] !== undefined) months[ym] += Number(p.amount||0);
  });
  document.getElementById('rev-oct').textContent = GBP(months['2025-10']);
  document.getElementById('rev-nov').textContent = GBP(months['2025-11']);
  document.getElementById('rev-dec').textContent = GBP(months['2025-12']);
}

// Charts
let chartMonths, chartSources;
function drawCharts(){
  const ctxM = document.getElementById('chart-months').getContext('2d');
  const ctxS = document.getElementById('chart-sources').getContext('2d');

  const sumByMonth = {'Oct':0,'Nov':0,'Dec':0};
  const sumBySource = {};
  pipeline.forEach(p => {
    if(p.status !== 'Closed Won' || p.currency !== 'GBP' || !p.date) return;
    const m = new Date(p.date).getMonth(); // 9,10,11
    const key = m===9?'Oct':m===10?'Nov':'Dec';
    sumByMonth[key] += Number(p.amount||0);
    sumBySource[p.source] = (sumBySource[p.source]||0) + Number(p.amount||0);
  });

  const monthData = [sumByMonth['Oct'], sumByMonth['Nov'], sumByMonth['Dec']];
  const sourceLabels = Object.keys(sumBySource);
  const sourceData = Object.values(sumBySource);

  if(chartMonths) chartMonths.destroy();
  if(chartSources) chartSources.destroy();

  chartMonths = new Chart(ctxM, {
    type: 'bar',
    data: { labels: ['Oct','Nov','Dec'], datasets: [{ label: 'GBP', data: monthData }] },
    options: { plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
  });
  chartSources = new Chart(ctxS, {
    type: 'doughnut',
    data: { labels: sourceLabels, datasets: [{ data: sourceData }] },
    options: { plugins:{legend:{position:'bottom'}} }
  });
}

renderPipeline();
</script>
</html>
"""

out_dir = "/mnt/data/ygp-90day-tracker"
os.makedirs(out_dir, exist_ok=True)
path = os.path.join(out_dir, "index.html")
with open(path, "w", encoding="utf-8") as f:
    f.write(html)

path

